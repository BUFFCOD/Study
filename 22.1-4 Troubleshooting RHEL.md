# 22.1 Using Troubleshooting Modes

┌──────────┐
│  UEFI    │
└────┬─────┘
     │
     │  (boot disk)  
     ▼
┌──────────┐
│  GRUB    │  ← bootloader
└────┬─────┘
     │
     │  (prompt)
     ▼
┌──────────┐
│ Kernel   │
│ + initramfs │
└────┬─────┘
     │
     │  init=/bin/bash
     │  (manual shell start)
     ▼
┌──────────┐
│ systemd  │  (PID 1)
└────┬─────┘
     │
     │  systemd.unit=rescue.target
     │  (single-user rescue shell)
     │
     │  systemd.unit=emergency.target
     │  (earliest emergency shell)
     ▼
┌──────────┐
│ services │
└────┬─────┘
     │
     ▼
┌──────────┐
│  shell   │
└──────────┘

## Recovering a Lost Root User Password

Enter Grub menu while booting 

Find the line that loads the linux kernel and add init=/bin/bash to the end of the line and boot.

Once in the minimal shell: mount -o remount,rw /

passwd root

touch /.autorelabel  # if SELinux is enabled

exec /usr/lib/systemd/systemd 


## Using the Boot Debug Shell

IF something goes wrong early in the boot process,  it may be useful to have an option to open a debug shell.
if this service is active it starts a rool shell that can be accessed on TTY9 (Ctrl+Alt+F9) during boot with out entering any password.

Obviously this useful for troubleshooting and analzing, but is a security risk if left enabled on production systems. Once no longer needed it should be disabled again.

```bash
systemctl enable debug-shell.service
systemctl disable debug-shell.service
```

## Troubleshooting Filesystem Issues

Real corruption does occur, but often , and is automatically fixed by RHEL.

Problems occur when making typos in /etc/fstab.

To fix: If necessary, remount filesystem in read/write state: mount -o remount,rw / and edit /etc/fstab to correct the error.

Fragmentation can be an issue, different tooles exist to fix it.

xfs_fsr  is the xfs filesystem Reorganizer, it optimizes XFS filesystems.

```bash 
xfs_fsr /mountpoint
```
e4defrag  is the ext4 filesystem defragmentation tool.

```bash
e4defrag /mountpoint
```

Issues often occur after modifying /etc/fstab.

To prevent having issues, do the following after making modifications,
    Use mount -a to mount all filesystems in /etc/fstab that haven't
    been mounted yet.

    Use findmnt --verify to verify syntax
    To verify that all works well use reboot after making changes to /etc/fstab