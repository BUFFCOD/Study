# Managing SSH


## 24.1 Understanding SSH Key-based Login 


# SSH Key-Based Login (Concept Diagram)

CLIENT                                     SERVER
------                                     ------

+----------------+          SSH            +----------------+
|                | ----------------------> |                |
|    ssh client  |                         |     sshd       |
|                |                         |                |
+----------------+                         +----------------+
        |                                          |
        |                                          |
        |  uses private key                        |  checks public key
        |                                          |
        v                                          v
~/.ssh/id_rsa                         ~/.ssh/authorized_keys
(private key)                          (public key)

------------------------------------------------------------

Authentication Flow:

1. User runs:
   ssh user@server

2. ssh client:
   - Reads private key from ~/.ssh/id_rsa
   - Sends proof (NOT the private key) to server

3. sshd on server:
   - Looks up user's ~/.ssh/authorized_keys
   - Compares public key
   - If match → login allowed

------------------------------------------------------------

IMPORTANT RULES:

- Private key NEVER leaves the client
- Public key is safe to copy to servers
- Permissions must be correct:
  - ~/.ssh        → 700
  - authorized_keys → 600


# SSH Authentication Methods

## 1. SSH with Host Verification (known_hosts)

When you connect to a server using:
ssh user@server_ip

SSH performs **host verification**.

- The server presents its **host key**
- The client stores this key in:
  ~/.ssh/known_hosts

This key identifies the **server**, not the user.

### What happens if the key changes?
- SSH will show a **WARNING**
- This usually means:
  - The server was reinstalled
  - The SSH host key was regenerated
  - OR a possible man-in-the-middle attack

SSH blocks the connection to protect you.

---

## 2. SSH Key-Based Authentication (Passwordless Login)

In key-based authentication, the **client generates a key pair**:

- Private key → stays on the client
- Public key → copied to the server

### Key locations
Client:
~/.ssh/id_rsa        (private key)
~/.ssh/id_rsa.pub    (public key)

Server:
~/.ssh/authorized_keys   (public key)

### Authentication flow

1. Client initiates SSH connection
2. Server sends a challenge
3. Client proves it owns the **private key**
4. Server verifies this using the **public key**
5. If valid → login allowed
6. No password is required

### Important corrections
- The private key is **never sent**
- The server does NOT decrypt anything with the public key
- The server verifies a cryptographic proof instead

---

## Key Security Rules (EXAM CRITICAL)

Permissions must be correct or SSH WILL FAIL:

Client:
~/.ssh → 700
id_rsa → 600

Server:
~/.ssh → 700
authorized_keys → 600


## 24.2 Setting up SSH Key-Based Login


ssh-keygen creates a public/private key pair for the current user
    Setting a passphrase for the private key makes it more secure, but less convenvient

    ssh-copy-id compies the public key over to the target server


## Caching SSH Keys

When using passphrases, entering a passphrase for every single command is inconvenient.

ssh-agent /bin/bash allocates space in the bash shell to cache the private key passphrase.

ssh-add adds the current passphrase to the cache

cached passphrases stay available for the rest of the session duration.

the GNOME graphical shell runs the gnome-keyring-daemon that automatically caches SSH private key passphrases.