# 21.1 Understanding the Kernal

the kernel is the part of the operating system that communitcates directly to the computer hardware

to do so the kernel user drivers which are provided as kernel modules.

kernel modules can be loaded automatically or manually.

the kernel provides system calls that can be used by programs to send instructions to the kernel.

The C library (glibc) provides interfaces for these applications to use the system calls.

# Linux System Architecture (Kernel Overview)

+--------------------------------------------------+
|                  USER SPACE                      |
|--------------------------------------------------|
|  Users                                           |
|  Shells (bash)                                   |
|  Commands (ls, cp, vim, dnf)                      |
|  Applications                                    |
|  Services (systemd units)                        |
|                                                  |
|  ‚ùå No direct hardware access                    |
+--------------------‚ñ≤-----------------------------+
                     |  System Calls (syscalls)
                     |  Permission checks
+--------------------‚ñº-----------------------------+
|                 SYSTEM/KERNEL SPACE                     |
|--------------------------------------------------|
|  Process scheduling                              |
|  Memory management                               |
|  Filesystems                                     |
|  Networking                                      |
|  Device drivers                                  |
|  Security & permissions                          |  
|                                                  |
|  Root is trusted here                            |
|  Kernel modules load here                        |
+--------------------‚ñ≤-----------------------------+
                     |  Direct control
+--------------------‚ñº-----------------------------+
|                    HARDWARE                      |
|--------------------------------------------------|
|  CPU                                             |
|  RAM                                             |
|  Disk                                            |
|  Network cards                                   |
|  USB devices                                     |
+--------------------------------------------------+

## Managing Kernel Modules

to verfiy loaded kernel modules use the `lsmod` command

```bash
lsmod
```
Another insightful command is lspci -k which lists Kernel modules that are loaded for the PCI devices foun on the system.

```bash
lspci -k 
```
When Linuxc is installed the initramfs is created to contain all kernal modules requires for the hardware that was found.

The systemd-udevd process works as a plug and play manager and dynamically loads kernel modules when triggered by hardware events.

TO influence how systemd-udevd should load modules and related parameters, rules are provided in /usr/lib/udev/rules.d/ and /etc/udev/rules.d/

the process of dynamically loading kernel modules can be traced with the udevadm monitor command.


Alternatively, kernel modules can be loaded manually with the `modprobe` command.

```bash
modprobe module_name
```
While loading kernel modules kernel parameters as shown by modinfo can be used.

To load a kernel module with its parameters automatically, use a configuration file in /etc/modprobe.d/ 

Veryfy if kernel modules parameters were loaded correctly using dmesg

To unload kernel modules use the `modprobe -r` command.

```bash    
modprobe -r module_name
```
What /etc/modprobe.d/ is

Holds .conf files that control kernel module behavior

Read by modprobe, udev, and during boot

One rule per line, # for comments

Files must end in .conf
Example:

/etc/modprobe.d/blacklist.conf
/etc/modprobe.d/usb.conf



1Ô∏è‚É£ Blacklist a module

Prevents a module from loading automatically.

blacklist usb_storage


üëâ Common in security hardening and troubleshooting.

To apply immediately:

sudo modprobe -r usb_storage

2Ô∏è‚É£ Set module options

Used to pass parameters to a kernel module.

options snd_hda_intel model=auto


Multiple options:

options kvm_intel nested=1 enable_apicv=1


## Exploring the /proc Filesystem

/proc is a pseudo-filesystem that provides an interface to kernel

Use it to get information about different kernel-related parts as well as to optimize kernel settings.

Status files are provided in /proc

Information about processes can be obtained from the PID directories in /proc/<PID>
Kernel tunables are provided in /proc/sys

To get information about kernel parameters use man 5 proc

For more information install the kernel documentation using dnf install kernel-docs 

access the documentation in /usr/share/doc/kernel-docs-<version>


## Making Persistent Changes to /proc !!important!! 

sysctl can be used to make /proc setting persistent.

Use sysctl -a for an overview of parameters.

 Parameters shown are filenames relative to /proc/sys, which use a  dot as the path separator.
To change settings, add the parameter with the desired value to /etc/sysctl.d

Package provided modifications are in /usr/lib/sysctl.d/

the reapply_sysctl parameter in /etc/tuned/tuned-main.conf determines whether sysctl or tuned parameters will be applied




## Objective
Disable responses to `ping` (ICMP echo requests) using a kernel parameter and verify the change.

---

## Step 1: Find the Relevant Kernel Parameter
Search for ICMP-related kernel parameters:
```bash
sysctl -a | grep icmp
Relevant parameter:

Copy code
net.ipv4.icmp_echo_ignore_all
Step 2: Temporarily Disable Ping (Runtime Change)
bash
Copy code
sudo sysctl net.ipv4.icmp_echo_ignore_all=1
Step 3: Test the Change
bash
Copy code
ping localhost
Expected Result
ICMP packets are sent

No replies are received

Step 4: Verify the Current Value
bash
Copy code
sysctl net.ipv4.icmp_echo_ignore_all
Expected output:

ini
Copy code
net.ipv4.icmp_echo_ignore_all = 1
Step 5: Make the Change Persistent
Create a sysctl configuration file:

bash
Copy code
sudo nano /etc/sysctl.d/99-icmp.conf
Add the following line:

ini
Copy code
net.ipv4.icmp_echo_ignore_all = 1
Apply the configuration:

bash
Copy code
sudo sysctl --system